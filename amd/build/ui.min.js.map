{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Modal from \"core/modal\";\nimport Mustache from 'core/mustache';\nimport {get_string as getString} from 'core/str';\nimport {component} from './common';\nimport {getHtmlBlocks} from \"./options\";\n\n/**\n * Javascript functions to handle the action inside the editor when clicking\n * the toolbar button or the menu item.\n *\n * @module      tiny_htmlblock\n * @copyright   2023 Stephan Robotta <stephan.robotta@bfh.ch>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst isNull = a => a === null || a === undefined;\n\n// The template for the modal dialogue.\nconst TEMPLATE = {\n  LIST: '<div class=\"tiny_htmlblock\">' +\n    '<p>{{intro}}</p>' +\n    '<ul>' +\n    '{{#list}}' +\n    '<li class=\"hbitem\" title=\"{{name}}\">' +\n    '{{{html}}}' +\n    '</li>' +\n    '{{/list}}' +\n    '</ul>' +\n    '</div>',\n  FOOTER: '<button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">{{cancel}}</button>' +\n    '<button type=\"button\" class=\"btn btn-primary\" data-action=\"save\">{{submit}}</button>',\n};\n\n// Language strings used in the modal dialogue.\nlet STR = {};\nconst getStr = async() => {\n  const res = await Promise.all([\n    getString('cancel', 'core'),\n    getString('dlgintro', component),\n    getString('dlginsert', component),\n    getString('pluginname', component),\n  ]);\n  [\n    'btn_cancel',\n    'dlg_intro',\n    'btn_insert',\n    'title',\n  ].map((l, i) => {\n    STR[l] = res[i];\n    return ''; // Make the linter happy.\n  });\n};\n\nlet  _modal;\nlet _editor;\n\n/**\n *\n * @param {TinyMCE.Editor} editor\n * @return {Promise<void>}\n */\nconst handleAction = async function(editor) {\n  // First call, they inject the editor and fetch the strings for the modal dialogue.\n  if (!_editor) {\n    _editor = editor;\n    await getStr();\n  }\n\n  // Create a modal dialogue.\n  _modal = await ModalFactory.create({\n    type: Modal.TYPE,\n    title: STR.title,\n    templateContext: {\n      elementid: _editor.id\n    },\n    removeOnClose: true,\n    large: true,\n  });\n  // And set the footer and content for the modal dialogue.\n  const footer = Mustache.render(TEMPLATE.FOOTER, {\n    cancel: STR.btn_cancel,\n    submit: STR.btn_insert,\n  });\n  const contentText = Mustache.render(TEMPLATE.LIST, {\n    intro: STR.dlg_intro,\n    list: getHtmlBlocks(_editor),\n  });\n  _modal.setBody(contentText);\n  _modal.setFooter(footer);\n  _modal.show();\n  // There are two buttons \"insert\" and \"cancel\" that must have a event handler attached to them.\n  _modal.registerEventListeners();\n  _modal.registerCloseOnSave();\n  _modal.registerCloseOnCancel();\n  const $root = _modal.getRoot();\n  $root.on(ModalEvents.save, insertHandler);\n  $root.on(ModalEvents.cancel, closeHandler);\n  // And an additional event handler for selecting one item in the list of HTML blocks.\n  $root.get(0).querySelectorAll('li').forEach(el => {\n    el.addEventListener('click', evt => {\n      evt.preventDefault();\n      const liSel = getTargetLi(evt);\n      if (isNull(liSel)) {\n        return;\n      }\n      liSel.parentNode.querySelectorAll('li').forEach(li => {\n        if (li === liSel) {\n          if (!isNull(li.classList)) {\n            li.classList.add('selected');\n          } else {\n            li.setAttribute('class', 'selected');\n          }\n        } else if (!isNull(li.classList)) {\n          li.classList.remove('selected');\n        }\n      });\n    });\n  });\n};\n\n/**\n * Insert the selected html block and close the dialogue afterwards.\n */\nconst insertHandler = function () {\n  const li = document.querySelector('li.hbitem.selected');\n  if (!isNull(li)) {\n    li.querySelectorAll('*[id^=\"yui_\"]').forEach(e => e.removeAttribute('id'));\n    _editor.execCommand('mceInsertContent', false, '<span class=\"marker_insert_htmlblock\">marker</span>');\n    const span = _editor.dom.select('span.marker_insert_htmlblock');\n    _editor.dom.setOuterHTML(span, li.innerHTML);\n  }\n  closeHandler();\n};\n\n/**\n * Destroy and unset the modal dialogue.\n */\nconst closeHandler = function () {\n  _modal.destroy();\n  _modal = null;\n};\n\n/**\n * From the submitted event (and target node) get the closest parent li.hbitem.\n * @param {Event} e\n * @return {Node|null}\n */\nconst getTargetLi = e => {\n  let p = e.target;\n  while (!isNull(p) && p.nodeType === 1 && p.tagName !== 'LI') {\n    p = p.parentNode;\n  }\n  if (isNull(p.classList)) {\n    return null;\n  }\n  if (p.classList.contains('hbitem')) {\n    return p;\n  }\n  return null;\n};\n\nexport {\n  handleAction,\n};"],"names":["isNull","a","TEMPLATE","STR","_modal","_editor","async","editor","res","Promise","all","component","map","l","i","getStr","ModalFactory","create","type","Modal","TYPE","title","templateContext","elementid","id","removeOnClose","large","footer","Mustache","render","cancel","btn_cancel","submit","btn_insert","contentText","intro","dlg_intro","list","setBody","setFooter","show","registerEventListeners","registerCloseOnSave","registerCloseOnCancel","$root","getRoot","on","ModalEvents","save","insertHandler","closeHandler","get","querySelectorAll","forEach","el","addEventListener","evt","preventDefault","liSel","getTargetLi","parentNode","li","classList","setAttribute","add","remove","document","querySelector","e","removeAttribute","execCommand","span","dom","select","setOuterHTML","innerHTML","destroy","p","target","nodeType","tagName","contains"],"mappings":";;;;;;;;8RAgCMA,OAASC,GAAKA,MAAAA,EAGdC,cACE,mIADFA,gBAWI,mLAKNC,IAAM,OAmBLC,OACDC,8BAOiBC,eAAeC,QAE7BF,UACHA,QAAUE,YA7BCD,iBACPE,UAAYC,QAAQC,IAAI,EAC5B,mBAAU,SAAU,SACpB,mBAAU,WAAYC,oBACtB,mBAAU,YAAaA,oBACvB,mBAAU,aAAcA,sBAGxB,aACA,YACA,aACA,SACAC,KAAI,CAACC,EAAGC,KACRX,IAAIU,GAAKL,IAAIM,GACN,OAgBDC,IAIRX,aAAeY,uBAAaC,OAAO,CACjCC,KAAMC,gBAAMC,KACZC,MAAOlB,IAAIkB,MACXC,gBAAiB,CACfC,UAAWlB,QAAQmB,IAErBC,eAAe,EACfC,OAAO,UAGHC,OAASC,kBAASC,OAAO3B,gBAAiB,CAC9C4B,OAAQ3B,IAAI4B,WACZC,OAAQ7B,IAAI8B,aAERC,YAAcN,kBAASC,OAAO3B,cAAe,CACjDiC,MAAOhC,IAAIiC,UACXC,MAAM,0BAAchC,WAEtBD,OAAOkC,QAAQJ,aACf9B,OAAOmC,UAAUZ,QACjBvB,OAAOoC,OAEPpC,OAAOqC,yBACPrC,OAAOsC,sBACPtC,OAAOuC,8BACDC,MAAQxC,OAAOyC,UACrBD,MAAME,GAAGC,sBAAYC,KAAMC,eAC3BL,MAAME,GAAGC,sBAAYjB,OAAQoB,cAE7BN,MAAMO,IAAI,GAAGC,iBAAiB,MAAMC,SAAQC,KAC1CA,GAAGC,iBAAiB,SAASC,MAC3BA,IAAIC,uBACEC,MAAQC,YAAYH,KACtBxD,OAAO0D,QAGXA,MAAME,WAAWR,iBAAiB,MAAMC,SAAQQ,KAC1CA,KAAOH,MACJ1D,OAAO6D,GAAGC,WAGbD,GAAGE,aAAa,QAAS,YAFzBF,GAAGC,UAAUE,IAAI,YAIThE,OAAO6D,GAAGC,YACpBD,GAAGC,UAAUG,OAAO,4BAUxBhB,cAAgB,iBACdY,GAAKK,SAASC,cAAc,0BAC7BnE,OAAO6D,IAAK,CACfA,GAAGT,iBAAiB,iBAAiBC,SAAQe,GAAKA,EAAEC,gBAAgB,QACpEhE,QAAQiE,YAAY,oBAAoB,EAAO,6DACzCC,KAAOlE,QAAQmE,IAAIC,OAAO,gCAChCpE,QAAQmE,IAAIE,aAAaH,KAAMV,GAAGc,WAEpCzB,gBAMIA,aAAe,WACnB9C,OAAOwE,UACPxE,OAAS,MAQLuD,YAAcS,QACdS,EAAIT,EAAEU,aACF9E,OAAO6E,IAAqB,IAAfA,EAAEE,UAAgC,OAAdF,EAAEG,SACzCH,EAAIA,EAAEjB,kBAEJ5D,OAAO6E,EAAEf,WACJ,KAELe,EAAEf,UAAUmB,SAAS,UAChBJ,EAEF"}